<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Installment Manager (Beta v21)</title>
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #e4e6eb;
            margin: 0;
            padding: 20px;
            color: #050505;
            font-size: 13px;
        }

        /* --- LOGIN VIEW STYLES --- */
        #login-view {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 40px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .login-icon {
            width: 64px;
            height: 64px;
            fill: #d93025; /* Red warning color */
            margin-bottom: 20px;
        }

        .login-version {
            font-weight: bold;
            color: #606770;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .login-warning {
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            margin-bottom: 25px;
        }

        #pin-input {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
            letter-spacing: 5px;
            box-sizing: border-box;
        }
        
        #btn-enter {
            width: 100%;
            padding: 12px;
            background-color: #1877f2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        #btn-enter:hover { background-color: #166fe5; }

        #pin-error {
            color: #d93025;
            margin-top: 15px;
            font-weight: bold;
            display: none;
        }

        /* --- APP VIEW STYLES --- */
        h1 {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 800;
            letter-spacing: -0.5px;
            /* position: relative; Removed for v21 fixed button */
        }

        /* v21: Fixed Position Settings Gear */
        #btn-settings {
            position: fixed;
            right: 15px;
            top: 15px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            color: #606770;
            cursor: pointer;
            z-index: 2000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #btn-settings:hover { color: #1877f2; }

        #container {
            width: fit-content;
            min-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: relative;
        }

        /* --- FILTERS BAR --- */
        #filter-bar {
            display: flex;
            gap: 20px;
            padding: 10px;
            background: #f0f2f5;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            flex-wrap: nowrap;
            overflow-x: auto;
            justify-content: flex-start;
        }
        
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
            border-right: 1px solid #ccc;
            padding-right: 15px;
            white-space: nowrap;
        }
        .filter-section:last-child { border-right: none; }

        .filter-master { font-weight: 800; font-size: 0.9em; margin-bottom: 3px; cursor: pointer; }
        .filter-subs { display: flex; gap: 10px; }
        .filter-label { font-size: 0.8em; color: #444; display: flex; align-items: center; cursor: pointer; }
        .filter-label input { margin-right: 4px; }

        /* Search & Actions */
        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        #search-bar {
            flex-grow: 1;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #000;
            border-radius: 4px;
        }

        .btn-save-all {
            background-color: #1877f2;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            display: none;
            white-space: nowrap;
        }
        .btn-save-all.visible { display: block; }

        /* Table Styles */
        table {
            border-collapse: collapse;
            width: auto;
        }

        th {
            background-color: #f0f2f5;
            padding: 8px 4px;
            text-align: center;
            font-size: 0.75em;
            text-transform: uppercase;
            color: #444;
            border-bottom: 2px solid #000;
            white-space: nowrap;
        }
        
        td {
            padding: 2px 4px;
            border-bottom: 1px solid #ccc;
            vertical-align: top;
        }

        /* Hiding Logic */
        .hide-col { display: none !important; }
        .hide-row { display: none !important; }

        /* Input Fields */
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: stretch;
            width: 100%;
        }

        input[type="text"], input[type="number"] {
            width: 50px;
            padding: 4px 2px;
            border: 1px solid #000;
            border-radius: 0;
            font-size: 13px;
            font-weight: 600;
            color: #000;
            background-color: #fff;
            text-align: center;
        }
        input.input-name { width: 140px; text-align: left; font-weight: normal; }
        
        input:focus {
            background-color: #fff;
            border: 2px solid #1877f2;
            outline: none;
            z-index: 2;
        }

        /* Lock Button Styling */
        .btn-lock {
            background-color: #f0f2f5;
            border: 1px solid #000;
            border-left: none;
            color: #ccc;
            width: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.1s;
        }
        
        .btn-lock:hover { background-color: #e4e6eb; color: #666; }
        
        .btn-lock.locked {
            color: #000;
            background-color: #d1d1d1;
        }

        .btn-lock.disabled {
            pointer-events: none;
            opacity: 0.5;
            background-color: #e0e0e0;
        }

        .group-tmo input[type="number"] {
            border-right: none; 
        }

        .input-disabled {
            background-color: #e0e0e0 !important;
            color: #999 !important;
            border-color: #ccc !important;
            pointer-events: none;
        }

        .icon-warn {
            color: #d93025;
            font-size: 12px;
            margin-left: 6px;
            align-self: center;
            display: none; 
        }
        .icon-warn.visible { display: inline-block; }

        /* --- ACCORDION ROW BEHAVIOR --- */
        tr.data-row {
            cursor: pointer;
            transition: background-color 0.1s;
        }
        tr.data-row:hover { background-color: #f7f8fa; }
        tr.data-row.active { 
            background-color: #eef3fc; 
            border-left: 3px solid #1877f2;
        }

        .row-meta, .row-actions, .name-lock-wrapper { display: none !important; }
        
        tr.active .row-meta { display: block !important; margin-top: 4px; }
        tr.active .row-actions { display: flex !important; gap: 10px; justify-content: center; margin-top: 5px; align-items: center; }
        tr.active .name-lock-wrapper { display: flex !important; align-items: center; font-size: 0.75em; color: #1877f2; margin-top: 2px; cursor: pointer; }

        .ts-label { font-size: 10px; color: #666; text-align: center; }
        .ts-recent { color: #008000; font-weight: bold; }

        .name-display { font-weight: bold; padding: 5px 2px; }
        .name-input-wrapper { display: none; }
        .name-unlocked .name-display { display: none; }
        .name-unlocked .name-input-wrapper { display: block; }

        .group-att { background-color: #87CEEB; color: #000; border: 1px solid #999; }
        .group-vzw { background-color: #ff6161; color: #000; border: 1px solid #999; }
        .group-tmo { background-color: #ff61b3; color: #000; border: 1px solid #999; }

        .danger-header { background-color: #ff61b3 !important; color: #000 !important; border-bottom: 2px solid #d93025; }
        input.input-danger { border: 1px solid #ff0303; background-color: #000 !important; color: #ff0303 !important; }
        input.input-danger:focus { border: 2px solid #ff0303; }

        .btn-icon {
            background: none; border: none; cursor: pointer; 
            font-size: 18px; padding: 0 10px; display: inline-flex;
            align-items: center; height: 100%;
        }
        .btn-save-row { color: #1877f2; }
        .btn-del-row { color: #d93025; }

        #add-row { background-color: #fff; border-bottom: 2px solid #000; }
        #add-row input { border: 1px dashed #666; }
        
        .sticky-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #ccc;
        }

        /* Developer Console */
        #dev-console-wrapper {
            margin-top: 30px; padding-top: 15px; border-top: 2px dashed #ccc; text-align: left;
        }
        #dev-console-container { margin-top: 10px; display: none; }
        #dev-console-output {
            background-color: #f5f5f5; border: 1px solid #999; color: #333;
            font-family: monospace; font-size: 11px; padding: 10px;
            height: 150px; overflow-y: scroll; white-space: pre-wrap; word-wrap: break-word;
        }
        .btn-copy-log {
            background-color: #606770; color: white; border: none;
            padding: 5px 10px; border-radius: 4px; cursor: pointer;
            margin-top: 5px; font-size: 12px;
        }

        /* Settings Modal */
        #settings-modal {
            display: none;
            position: fixed; z-index: 3000; /* Higher than gear */
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fff; padding: 20px; border-radius: 8px; width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .modal-header { font-weight: bold; margin-bottom: 15px; font-size: 16px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; font-size: 11px; color: #666; margin-bottom: 4px; }
        .form-group input { width: 100%; box-sizing: border-box; text-align: left; }
        .modal-actions { text-align: right; margin-top: 15px; }
        .btn-modal { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-cancel { background: #e4e6eb; color: #333; margin-right: 5px; }
        .btn-save-settings { background: #1877f2; color: white; }

    </style>
</head>
<body>

    <!-- GATEKEEPER VIEW -->
    <div id="login-view">
        <div class="login-version">Installment Manager (Beta v21)</div>
        <svg class="login-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
        </svg>
        <p class="login-warning">
            Enter passcode to access Installment Manager.<br><br>
            By entering, you understand changes made here will have effects for all platforms that Optimizer uses.
        </p>
        <input type="tel" id="pin-input" placeholder="Enter PIN">
        <button id="btn-enter">Enter</button>
        <p id="pin-error">Incorrect PIN</p>
    </div>

    <!-- APP VIEW (Hidden by default) -->
    <div id="app-view" style="display: none;">
        
        <h1>Installment Manager (Beta v21)</h1>
        <!-- v21: Fixed position settings button -->
        <button id="btn-settings" title="Cloud Settings"><i class="fas fa-cog"></i></button>

        <div id="container">
            
            <!-- Filter Bar -->
            <div id="filter-bar">
                <!-- TMO Incompatible Toggle -->
                <div class="filter-section" style="border-right: 2px solid #000;">
                    <label class="filter-label" style="font-weight:bold; color:#d93025;">
                        <input type="checkbox" id="cb-incompatible"> Edit and show incompatible items
                    </label>
                </div>

                <!-- ATT Group -->
                <div class="filter-section">
                    <label class="filter-master"><input type="checkbox" id="m-att" checked> AT&T</label>
                    <div class="filter-subs">
                        <label class="filter-label"><input type="checkbox" id="cb-att-mo" data-group="att" checked> Mo</label>
                        <label class="filter-label"><input type="checkbox" id="cb-att-tot" data-group="att" checked> Total</label>
                    </div>
                </div>
                <!-- VZW Group -->
                <div class="filter-section">
                    <label class="filter-master"><input type="checkbox" id="m-vzw" checked> Verizon</label>
                    <div class="filter-subs">
                        <label class="filter-label"><input type="checkbox" id="cb-vzw-mo" data-group="vzw" checked> Mo</label>
                        <label class="filter-label"><input type="checkbox" id="cb-vzw-tot" data-group="vzw" checked> Total</label>
                    </div>
                </div>
                <!-- TMO Group -->
                <div class="filter-section">
                    <label class="filter-master"><input type="checkbox" id="m-tmo" checked> T-Mobile</label>
                    <div class="filter-subs">
                        <label class="filter-label"><input type="checkbox" id="cb-tmo-red" data-group="tmo" checked style="color:#d93025; font-weight:bold;"> NO DP</label>
                        <label class="filter-label"><input type="checkbox" id="cb-tmo-dp" data-group="tmo"> DP</label>
                        <label class="filter-label"><input type="checkbox" id="cb-tmo-mo" data-group="tmo"> Mo</label>
                        <label class="filter-label"><input type="checkbox" id="cb-tmo-tot" data-group="tmo" checked> Total</label>
                    </div>
                </div>
            </div>

            <!-- Top Controls -->
            <div class="controls-row">
                <input type="text" id="search-bar" placeholder="Search devices...">
                <button class="btn-save-all" id="btn-save-top">Save All Changes</button>
            </div>

            <div class="table-wrapper">
                <table id="main-table">
                    <thead>
                        <tr>
                            <th class="col-name">Device</th>
                            
                            <!-- ATT Headers -->
                            <th class="group-att c-att-mo">$/mo</th>
                            <th class="group-att c-att-tot">Total</th>
                            
                            <!-- VZW Headers -->
                            <th class="group-vzw c-vzw-mo">$/mo</th>
                            <th class="group-vzw c-vzw-tot">Total</th>
                            
                            <!-- TMO Headers -->
                            <th class="group-tmo c-tmo-red danger-header">MO IF<br>NO DP</th>
                            <th class="group-tmo c-tmo-dp">Down</th>
                            <th class="group-tmo c-tmo-mo">Mo<br><span style="font-size:0.7em; font-weight:normal;">(after dp)</span></th>
                            <th class="group-tmo c-tmo-tot">Total</th>
                            
                            <th class="col-actions" style="width: 50px;"></th>
                        </tr>
                        
                        <!-- Add New Row -->
                        <tr id="add-row">
                            <td><input type="text" id="new-name" class="input-name" placeholder="New Device Name"></td>
                            
                            <td class="c-att-mo group-att"><input type="number" id="new-att-mo" step="0.01"></td>
                            <td class="c-att-tot group-att"><input type="number" id="new-att-total"></td>
                            
                            <td class="c-vzw-mo group-vzw"><input type="number" id="new-vzw-mo" step="0.01"></td>
                            <td class="c-vzw-tot group-vzw"><input type="number" id="new-vzw-total"></td>
                            
                            <td class="c-tmo-red group-tmo"><input type="number" id="new-tmo-red" class="input-danger" step="0.01"></td>
                            <td class="c-tmo-dp group-tmo"><input type="number" id="new-tmo-dp"></td>
                            <td class="c-tmo-mo group-tmo"><input type="number" id="new-tmo-mo" step="0.01"></td>
                            <td class="c-tmo-tot group-tmo"><input type="number" id="new-tmo-total"></td>
                            
                            <td style="text-align:center;"><button id="btn-add-device" class="btn-icon" style="color:green;"><i class="fas fa-plus"></i></button></td>
                        </tr>
                    </thead>
                    <tbody id="device-list">
                        <!-- Data Rows -->
                    </tbody>
                </table>
                <div id="loading-msg" style="text-align:center; padding:20px; color:#666;">Connecting...</div>
            </div>

            <!-- Bottom Controls -->
            <div class="sticky-footer">
                <button class="btn-save-all" id="btn-save-bottom">Save All Changes</button>
            </div>

            <!-- Developer Console (Restored v20.1) -->
            <div id="dev-console-wrapper">
                <label><input type="checkbox" id="dev-console-toggle"> Show Developer Console</label>
                <div id="dev-console-container">
                    <pre id="dev-console-output"></pre>
                    <button class="btn-copy-log" id="btn-copy-log">Copy Log</button>
                </div>
            </div>
        </div>

        <!-- v18 Settings Modal -->
        <div id="settings-modal">
            <div class="modal-content">
                <div class="modal-header">Cloud Publisher Settings</div>
                <div class="form-group">
                    <label>GitHub Username</label>
                    <input type="text" id="gh-user" placeholder="e.g. spamfan">
                </div>
                <div class="form-group">
                    <label>Repository Name</label>
                    <input type="text" id="gh-repo" placeholder="e.g. optimizerunstable">
                </div>
                <div class="form-group">
                    <label>File Path</label>
                    <input type="text" id="gh-path" value="edlp_data.json" readonly>
                </div>
                <div class="form-group">
                    <label>Personal Access Token (PAT)</label>
                    <input type="password" id="gh-token" placeholder="ghp_...">
                </div>
                <div class="modal-actions">
                    <button class="btn-modal btn-cancel" id="btn-close-settings">Close</button>
                    <button class="btn-modal btn-save-settings" id="btn-save-gh">Save Credentials</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- GATEKEEPER LOGIC (v21) ---
        const PIN_CODE = "102030";
        const pinInput = document.getElementById('pin-input');
        const btnEnter = document.getElementById('btn-enter');
        const pinError = document.getElementById('pin-error');
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');

        const checkPin = () => {
            if (pinInput.value === PIN_CODE) {
                loginView.style.display = 'none';
                appView.style.display = 'block';
            } else {
                pinError.style.display = 'block';
                pinInput.value = '';
                pinInput.focus();
            }
        };

        btnEnter.addEventListener('click', checkPin);
        pinInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') checkPin();
        });

        // --- LOGGER ---
        function log(msg) {
            const out = document.getElementById('dev-console-output');
            if (!out) return; // Safety check
            const now = new Date();
            const ts = now.toISOString().split('T')[1].slice(0,-1); 
            out.textContent += `[${ts}] ${msg}\n`;
            out.scrollTop = out.scrollHeight;
        }

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDHVW6d6n-lS43mf9DIsSYJjzBWvk4B1R4",
            authDomain: "optimizer-data.firebaseapp.com",
            databaseURL: "https://optimizer-data-default-rtdb.firebaseio.com",
            projectId: "optimizer-data",
            storageBucket: "optimizer-data.firebasestorage.app",
            messagingSenderId: "162386405726",
            appId: "1:162386405726:web:a5f22c3810152949b947cf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- STATE ---
        let devicesData = {};
        let dirtyRows = new Set(); 
        let dirtyCarriers = {}; // Granular Dirty Tracking
        let isSaving = false;

        // v17: Compatibility List
        const TMO_EXCLUDED = [
            /Galaxy S\d+/i,
            /One Ace 5G/i,
            /Z Flip 4/i,
            /Galaxy Z Flip 4/i
        ];

        // --- DOM ---
        const deviceListEl = document.getElementById('device-list');
        const searchBar = document.getElementById('search-bar');
        const btnSaveTop = document.getElementById('btn-save-top');
        const btnSaveBottom = document.getElementById('btn-save-bottom');
        const incompatibleToggle = document.getElementById('cb-incompatible');
        
        // --- SETTINGS LOGIC ---
        const btnSettings = document.getElementById('btn-settings');
        const settingsModal = document.getElementById('settings-modal');
        const btnCloseSettings = document.getElementById('btn-close-settings');
        const btnSaveGh = document.getElementById('btn-save-gh');

        if (btnSettings) {
            btnSettings.addEventListener('click', () => {
                const config = JSON.parse(localStorage.getItem('gh_config') || '{}');
                document.getElementById('gh-user').value = config.user || 'spamfan';
                document.getElementById('gh-repo').value = config.repo || 'optimizerunstable'; 
                document.getElementById('gh-token').value = config.token || '';
                settingsModal.style.display = 'flex';
            });
        }

        if (btnCloseSettings) {
            btnCloseSettings.addEventListener('click', () => settingsModal.style.display = 'none');
        }

        if (btnSaveGh) {
            btnSaveGh.addEventListener('click', () => {
                const user = document.getElementById('gh-user').value.trim();
                const repo = document.getElementById('gh-repo').value.trim();
                const token = document.getElementById('gh-token').value.trim();
                if (!user || !repo || !token) return alert("All fields required");
                localStorage.setItem('gh_config', JSON.stringify({ user, repo, token }));
                settingsModal.style.display = 'none';
                log("âœ… GitHub credentials saved locally.");
            });
        }

        // --- GITHUB PUBLISHER ---
        async function publishToGitHub(data) {
            const config = JSON.parse(localStorage.getItem('gh_config') || '{}');
            if (!config.token) {
                log("âš ï¸ No GitHub token found. Skipping publish.");
                return;
            }

            const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/edlp_data.json`;
            const content = btoa(JSON.stringify({ devices: data }, null, 2)); 
            
            try {
                // 1. Get SHA
                const getReq = await fetch(url, {
                    headers: { 'Authorization': `token ${config.token}` }
                });
                const getRes = await getReq.json();
                const sha = getRes.sha;

                // 2. Put Update
                const putReq = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update from Installment Manager ${new Date().toISOString()}`,
                        content: content,
                        sha: sha
                    })
                });

                if (putReq.ok) {
                    log("â˜ï¸ SUCCESS: Published to GitHub!");
                } else {
                    const err = await putReq.json();
                    log(`âŒ GITHUB ERROR: ${err.message}`);
                }
            } catch (e) {
                log(`âŒ PUBLISH FAILED: ${e.message}`);
            }
        }

        // --- CONSOLE ---
        const devToggle = document.getElementById('dev-console-toggle');
        const devContainer = document.getElementById('dev-console-container');
        
        if (devToggle) {
            devToggle.addEventListener('change', (e) => {
                if (devContainer) devContainer.style.display = e.target.checked ? 'block' : 'none';
            });
        }

        const copyBtn = document.getElementById('btn-copy-log');
        if (copyBtn) {
            copyBtn.addEventListener('click', () => {
                const text = document.getElementById('dev-console-output').textContent;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text)
                        .then(() => alert("Log copied!"))
                        .catch(() => legacyCopy(text));
                } else {
                    legacyCopy(text);
                }
            });
        }

        function legacyCopy(text) {
            const ta = document.createElement('textarea'); ta.value = text;
            ta.style.position = 'fixed'; ta.style.opacity = 0; document.body.appendChild(ta);
            ta.focus(); ta.select(); try { document.execCommand('copy'); } catch (err) {} document.body.removeChild(ta);
        }

        // --- FILTER LOGIC ---
        const colMap = {
            'cb-att-mo': 'c-att-mo', 'cb-att-tot': 'c-att-tot',
            'cb-vzw-mo': 'c-vzw-mo', 'cb-vzw-tot': 'c-vzw-tot',
            'cb-tmo-red': 'c-tmo-red', 'cb-tmo-dp': 'c-tmo-dp', 'cb-tmo-mo': 'c-tmo-mo', 'cb-tmo-tot': 'c-tmo-tot'
        };

        ['att', 'vzw', 'tmo'].forEach(carrier => {
            const master = document.getElementById(`m-${carrier}`);
            if (master) {
                master.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    document.querySelectorAll(`input[data-group="${carrier}"]`).forEach(cb => {
                        cb.checked = isChecked;
                        toggleCol(colMap[cb.id], isChecked);
                    });
                    renderTable(); 
                });
            }
        });

        Object.keys(colMap).forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', (e) => toggleCol(colMap[id], e.target.checked));
        });

        function toggleCol(className, isVisible) {
            const cells = document.querySelectorAll('.' + className);
            cells.forEach(c => c.classList.toggle('hide-col', !isVisible));
        }

        if (incompatibleToggle) incompatibleToggle.addEventListener('change', renderTable);

        // --- MATH ---
        const roundMo = (n) => Math.round((parseFloat(n)||0)*100)/100;
        const roundTot = (n) => Math.round(parseFloat(n)||0);
        
        const calc36_Tot = (m) => roundTot(m*36);
        const calc36_Mo = (t) => roundMo(t/36);
        
        const calcTmo_Mo = (t, d) => roundMo((t-d)/24);
        const calcTmo_Tot = (m, d) => roundTot(d+(m*24));
        const calcTmo_Red = (t) => roundMo(t/24); 
        const calcTmo_TotFromRed = (r) => roundTot(r*24);

        // --- RENDER ---
        function formatTimestamp(ts) {
            if (!ts) return '';
            const d = new Date(ts);
            const now = new Date();
            const diff = (now-d)/(1000*60*60);
            const str = `${d.getMonth()+1}/${d.getDate()}`;
            if (diff < 72) {
                const h = d.getHours().toString().padStart(2,'0');
                const m = d.getMinutes().toString().padStart(2,'0');
                return `<span class="ts-recent">${str} ${h}:${m}</span>`;
            }
            return str;
        }

        const devicesRef = ref(db, 'devices');
        onValue(devicesRef, (snapshot) => {
            if (isSaving) {
                devicesData = snapshot.val() || {}; 
                return;
            }
            document.getElementById('loading-msg').style.display = 'none';
            devicesData = snapshot.val() || {};
            dirtyRows.clear();
            dirtyCarriers = {}; 
            updateSaveAllButtons();
            renderTable();
        });

        function renderTable() {
            deviceListEl.innerHTML = '';
            const term = searchBar.value.toLowerCase();
            const keys = Object.keys(devicesData).sort((a,b) => (devicesData[a].name||'').localeCompare(devicesData[b].name||''));
            
            const showIncompatible = incompatibleToggle ? incompatibleToggle.checked : false;
            const attVisible = document.getElementById('m-att') ? document.getElementById('m-att').checked : true;
            const vzwVisible = document.getElementById('m-vzw') ? document.getElementById('m-vzw').checked : true;

            keys.forEach(key => {
                const d = devicesData[key];
                const nameLower = d.name.toLowerCase();
                
                if (term && !nameLower.includes(term)) return;

                const isExcluded = TMO_EXCLUDED.some(regex => regex.test(d.name));
                let tmoDisabledClass = '';
                let lockDisabledClass = '';

                if (isExcluded && !showIncompatible) {
                    if (!attVisible && !vzwVisible) {
                        return; 
                    }
                    tmoDisabledClass = 'input-disabled'; 
                    lockDisabledClass = 'disabled'; 
                }

                const getTs = (c) => c?.last_updated || d.last_updated;
                const row = document.createElement('tr');
                row.className = 'data-row';
                row.dataset.key = key;
                row.dataset.original = JSON.stringify(d);

                const tmoTot = parseFloat(d.tmo?.total) || 0;
                const redVal = tmoTot ? calcTmo_Red(tmoTot) : '';
                const val = (v) => (v === 0 || v === "0" || !v) ? "" : v;

                const lockIcon = `<div class="btn-lock ${lockDisabledClass}" title="Toggle Lock"><i class="fas fa-lock-open"></i></div>`;

                row.innerHTML = `
                    <td class="col-name">
                        <div class="name-display">${d.name}</div>
                        <div class="name-input-wrapper">
                            <input type="text" class="input-name" value="${d.name}">
                        </div>
                        <div class="name-lock-wrapper"><i class="fas fa-lock"></i> &nbsp;Edit Title</div>
                    </td>
                    
                    <td class="c-att-mo group-att"><input type="number" class="i-att-mo" value="${val(d.att?.monthly)}" step="0.01"><div class="row-meta ts-label">${formatTimestamp(getTs(d.att))}</div></td>
                    <td class="c-att-tot group-att"><input type="number" class="i-att-tot" value="${val(d.att?.total)}"><div class="row-meta"></div></td>
                    
                    <td class="c-vzw-mo group-vzw"><input type="number" class="i-vzw-mo" value="${val(d.vzw?.monthly)}" step="0.01"><div class="row-meta ts-label">${formatTimestamp(getTs(d.vzw))}</div></td>
                    <td class="c-vzw-tot group-vzw"><input type="number" class="i-vzw-tot" value="${val(d.vzw?.total)}"><div class="row-meta"></div></td>
                    
                    <td class="c-tmo-red group-tmo">
                        <div class="input-wrapper">
                            <input type="number" class="i-tmo-red input-danger ${tmoDisabledClass}" value="${val(redVal)}" step="0.01">${lockIcon}
                        </div>
                        <div class="row-meta"></div>
                    </td>
                    <td class="c-tmo-dp group-tmo">
                        <div class="input-wrapper">
                            <input type="number" class="i-tmo-dp ${tmoDisabledClass}" value="${val(d.tmo?.dp)}">${lockIcon}
                        </div>
                        <div class="row-meta"></div>
                    </td>
                    <td class="c-tmo-mo group-tmo">
                        <div class="input-wrapper">
                            <input type="number" class="i-tmo-mo ${tmoDisabledClass}" value="${val(d.tmo?.monthly)}" step="0.01">${lockIcon}
                        </div>
                        <div class="row-meta ts-label">${formatTimestamp(getTs(d.tmo))}</div>
                    </td>
                    <td class="c-tmo-tot group-tmo">
                        <div class="input-wrapper">
                            <input type="number" class="i-tmo-tot ${tmoDisabledClass}" value="${val(d.tmo?.total)}">${lockIcon} <i class="fas fa-exclamation-triangle icon-warn" title="Math mismatch"></i>
                        </div>
                        <div class="row-meta"></div>
                    </td>
                    
                    <td class="col-actions">
                        <div class="row-actions">
                            <button class="btn-icon btn-save-row" title="Save & Verify"><i class="fas fa-save"></i></button>
                            <button class="btn-icon btn-del-row" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;

                const activate = () => {
                    document.querySelectorAll('tr.active').forEach(r => r !== row && r.classList.remove('active'));
                    row.classList.add('active');
                };
                row.addEventListener('click', (e) => { if(e.target.tagName !== 'INPUT' && !e.target.classList.contains('btn-lock') && !e.target.parentElement.classList.contains('btn-lock')) activate(); });
                row.addEventListener('focusin', activate);

                row.querySelector('.name-lock-wrapper').addEventListener('click', (e) => {
                    e.stopPropagation();
                    row.querySelector('.col-name').classList.add('name-unlocked');
                });

                attachRowListeners(row, key);
                deviceListEl.appendChild(row);
            });
            
            Object.keys(colMap).forEach(id => {
                const cb = document.getElementById(id);
                if(cb) toggleCol(colMap[id], cb.checked);
            });
        }

        // v19 Helper: Mark carrier dirty
        function markCarrierDirty(key, carrier) {
            if (!dirtyCarriers[key]) dirtyCarriers[key] = { att: false, vzw: false, tmo: false };
            dirtyCarriers[key][carrier] = true;
        }

        function attachRowListeners(row, key) {
            const inputs = row.querySelectorAll('input');
            const saveBtn = row.querySelector('.btn-save-row');
            const delBtn = row.querySelector('.btn-del-row');
            const locks = row.querySelectorAll('.btn-lock');

            locks.forEach(lock => {
                lock.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (lock.classList.contains('disabled')) return;
                    lock.classList.toggle('locked');
                    
                    // v20 Fix: Swap Icon Class
                    const icon = lock.querySelector('i');
                    if (lock.classList.contains('locked')) {
                        icon.classList.remove('fa-lock-open');
                        icon.classList.add('fa-lock');
                    } else {
                        icon.classList.remove('fa-lock');
                        icon.classList.add('fa-lock-open');
                    }

                    validateRow(row);
                    markCarrierDirty(key, 'tmo');
                    dirtyRows.add(key);
                    updateSaveAllButtons();
                });
            });

            inputs.forEach(inp => {
                inp.addEventListener('focus', (e) => {
                    if (inp.closest('.group-att')) markCarrierDirty(key, 'att');
                    if (inp.closest('.group-vzw')) markCarrierDirty(key, 'vzw');
                    if (inp.closest('.group-tmo')) markCarrierDirty(key, 'tmo');
                });

                inp.addEventListener('input', (e) => {
                    if (!dirtyRows.has(key)) log(`âœï¸ EDIT: Row '${key}' marked dirty.`);
                    dirtyRows.add(key);
                    
                    const t = e.target;
                    if (t.closest('.group-att')) markCarrierDirty(key, 'att');
                    if (t.closest('.group-vzw')) markCarrierDirty(key, 'vzw');
                    if (t.closest('.group-tmo')) markCarrierDirty(key, 'tmo');

                    updateSaveAllButtons();
                    
                    const getV = (el) => parseFloat(el.value) || 0;

                    // Standard ATT/VZW logic
                    if (t.classList.contains('i-att-tot')) row.querySelector('.i-att-mo').value = t.value ? calc36_Mo(t.value) : '';
                    if (t.classList.contains('i-att-mo')) row.querySelector('.i-att-tot').value = t.value ? calc36_Tot(t.value) : '';
                    if (t.classList.contains('i-vzw-tot')) row.querySelector('.i-vzw-mo').value = t.value ? calc36_Mo(t.value) : '';
                    if (t.classList.contains('i-vzw-mo')) row.querySelector('.i-vzw-tot').value = t.value ? calc36_Tot(t.value) : '';
                    
                    // TMO Solver Logic (v16)
                    if (t.className.includes('i-tmo')) {
                        solveTmoRow(row, t);
                    }
                    
                    validateRow(row);
                });
            });

            saveBtn.addEventListener('click', (e) => { 
                e.stopPropagation(); 
                const data = scrapeRowData(row, key);
                sendRowData(key, data).then(() => {
                    dirtyRows.delete(key);
                    if (dirtyCarriers[key]) delete dirtyCarriers[key]; 
                    updateSaveAllButtons();
                    get(ref(db, 'devices')).then(snap => {
                        const allData = snap.val() || {};
                        publishToGitHub(allData);
                    });
                });
            });

            delBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm('Delete?')) remove(ref(db, 'devices/'+key));
            });
            
            validateRow(row);
        }

        function solveTmoRow(row, triggerInput) {
            const redIn = row.querySelector('.i-tmo-red');
            const dpIn = row.querySelector('.i-tmo-dp');
            const moIn = row.querySelector('.i-tmo-mo');
            const totIn = row.querySelector('.i-tmo-tot');

            const isLocked = (el) => el.parentElement.querySelector('.btn-lock').classList.contains('locked');
            const redL = isLocked(redIn);
            const dpL = isLocked(dpIn);
            const moL = isLocked(moIn);
            const totL = isLocked(totIn);

            const getV = (el) => parseFloat(el.value) || 0;

            if (triggerInput === redIn) {
                const val = parseFloat(redIn.value) || 0;
                if (!totL) totIn.value = val ? calcTmo_TotFromRed(val) : '';
                if (!dpL && !moL) { dpIn.value = ''; moIn.value = ''; }
                else if (dpL && !moL) {
                    const tot = getV(totIn); const dp = getV(dpIn);
                    moIn.value = tot > 0 ? ((tot - dp) / 24).toFixed(2) : '';
                }
                else if (moL && !dpL) {
                    const tot = getV(totIn); const mo = getV(moIn);
                    dpIn.value = tot > 0 ? (tot - (mo * 24)).toFixed(2) : '';
                }
            }

            if (triggerInput === totIn) {
                const val = parseFloat(totIn.value) || 0;
                if (!redL) redIn.value = val ? calcTmo_Red(val) : '';
                if (!dpL && !moL) { dpIn.value = ''; moIn.value = ''; }
                else if (dpL && !moL) {
                    const dp = getV(dpIn);
                    moIn.value = val > 0 ? ((val - dp) / 24).toFixed(2) : '';
                }
                else if (moL && !dpL) {
                    const mo = getV(moIn);
                    dpIn.value = val > 0 ? (val - (mo * 24)).toFixed(2) : '';
                }
            }

            if (triggerInput === dpIn) {
                const dp = parseFloat(dpIn.value) || 0;
                const mo = getV(moIn);
                const tot = getV(totIn);
                
                if (totL) { 
                    if (!moL) moIn.value = tot > 0 ? ((tot - dp) / 24).toFixed(2) : '';
                } else if (moL) { 
                    const newTot = dp + (mo * 24);
                    totIn.value = newTot;
                    if (!redL) redIn.value = calcTmo_Red(newTot);
                } else {
                    if (mo > 0) { 
                        const newTot = calcTmo_Tot(mo, dp);
                        totIn.value = newTot;
                        if (!redL) redIn.value = calcTmo_Red(newTot);
                    } else if (tot > 0) { 
                        const newMo = calcTmo_Mo(tot, dp);
                        moIn.value = newMo > 0 ? newMo : '';
                    }
                }
            }

            if (triggerInput === moIn) {
                const mo = parseFloat(moIn.value) || 0;
                const dp = getV(dpIn);
                const tot = getV(totIn);

                if (totL) { 
                    if (!dpL) dpIn.value = tot > 0 ? (tot - (mo * 24)).toFixed(2) : '';
                } else if (dpL) { 
                    const newTot = dp + (mo * 24);
                    totIn.value = newTot;
                    if (!redL) redIn.value = calcTmo_Red(newTot);
                } else {
                    if (dp > 0) { 
                        const newTot = calcTmo_Tot(mo, dp);
                        totIn.value = newTot;
                        if (!redL) redIn.value = calcTmo_Red(newTot);
                    } else if (tot > 0) { 
                        const newDp = tot - (mo * 24);
                        dpIn.value = newDp > 0 ? Math.round(newDp * 100) / 100 : '';
                    }
                }
            }
        }

        function validateRow(row) {
            const getV = (sel) => parseFloat(row.querySelector(sel).value) || 0;
            const red = getV('.i-tmo-red');
            const dp = getV('.i-tmo-dp');
            const mo = getV('.i-tmo-mo');
            const tot = getV('.i-tmo-tot');
            const warnIcon = row.querySelector('.icon-warn');

            if (tot === 0) { warnIcon.classList.remove('visible'); return; }

            const redCheck = Math.abs(tot - (red * 24)) > 0.24; // v17 Tolerance
            let partsCheck = false;
            if (dp > 0 || mo > 0) {
                 partsCheck = Math.abs(tot - (dp + (mo * 24))) > 0.24; // v17 Tolerance
            }

            if (redCheck || partsCheck) {
                warnIcon.classList.add('visible');
            } else {
                warnIcon.classList.remove('visible');
            }
        }

        function scrapeRowData(row, key) {
            const orig = JSON.parse(row.dataset.original);
            const getVal = (sel) => parseFloat(row.querySelector(sel).value) || 0;
            const getName = () => row.querySelector('.input-name').value;
            const now = Date.now();
            
            const flags = dirtyCarriers[key] || { att: false, vzw: false, tmo: false };

            return {
                name: getName(),
                att: { 
                    monthly: getVal('.i-att-mo'), total: getVal('.i-att-tot'),
                    last_updated: flags.att ? now : (orig.att?.last_updated || now)
                },
                vzw: { 
                    monthly: getVal('.i-vzw-mo'), total: getVal('.i-vzw-tot'),
                    last_updated: flags.vzw ? now : (orig.vzw?.last_updated || now)
                },
                tmo: { 
                    dp: getVal('.i-tmo-dp'), monthly: getVal('.i-tmo-mo'), total: getVal('.i-tmo-tot'),
                    last_updated: flags.tmo ? now : (orig.tmo?.last_updated || now)
                }
            };
        }

        function sendRowData(key, data) {
            log(`â¬†ï¸ SENDING: Update for ${data.name} (${key})...`);
            return update(ref(db, 'devices/'+key), data)
                .then(() => log(`âœ… SAVED: ${data.name}`))
                .catch(err => log(`âŒ ERROR: ${data.name} - ${err.message}`));
        }

        function updateSaveAllButtons() {
            const hasDirty = dirtyRows.size > 0;
            btnSaveTop.classList.toggle('visible', hasDirty);
            btnSaveBottom.classList.toggle('visible', hasDirty);
            btnSaveTop.textContent = `Save ${dirtyRows.size} Changes`;
            btnSaveBottom.textContent = `Save ${dirtyRows.size} Changes`;
        }

        const handleBulkSave = () => {
            log(`ðŸ’¾ BULK SAVE: Processing ${dirtyRows.size} rows.`);
            isSaving = true; 
            const updates = [];
            dirtyRows.forEach(key => {
                const row = document.querySelector(`tr[data-key="${key}"]`);
                if (row) {
                    const data = scrapeRowData(row, key);
                    updates.push({ key, data });
                }
            });
            const promises = map(item => sendRowData(item.key, item.data));
            Promise.all(promises).then(() => {
                log('âœ… FIREBASE SYNC COMPLETE.');
                
                const allData = devicesData; 
                publishToGitHub(allData);

                dirtyRows.clear();
                dirtyCarriers = {}; 
                isSaving = false; 
                updateSaveAllButtons();
                renderTable(); 
            });
        };

        if (btnSaveTop) btnSaveTop.addEventListener('click', handleBulkSave);
        if (btnSaveBottom) btnSaveBottom.addEventListener('click', handleBulkSave);

        // Add New Logic
        const addRow = document.getElementById('add-row');
        const addInputs = addRow.querySelectorAll('input');
        
        addRow.addEventListener('input', (e) => {
             const t = e.target;
             if (t.id === 'new-att-total') document.getElementById('new-att-mo').value = calc36_Mo(t.value);
             if (t.id === 'new-att-mo') document.getElementById('new-att-total').value = calc36_Tot(t.value);
             if (t.id === 'new-vzw-total') document.getElementById('new-vzw-mo').value = calc36_Mo(t.value);
             if (t.id === 'new-vzw-mo') document.getElementById('new-vzw-total').value = calc36_Tot(t.value);
             
             // TMO Add Logic (Simplified v14 Logic for Add Row)
             const dpIn = document.getElementById('new-tmo-dp');
             const redIn = document.getElementById('new-tmo-red');
             const totIn = document.getElementById('new-tmo-total');
             const moIn = document.getElementById('new-tmo-mo');
             
             const getV = (el) => parseFloat(el.value) || 0;

             if (t === redIn) {
                 const totalVal = t.value ? calcTmo_TotFromRed(t.value) : '';
                 totIn.value = totalVal;
                 dpIn.value = ''; moIn.value = '';
             }
             if (t === totIn) {
                 const tot = parseFloat(t.value);
                 redIn.value = t.value ? calcTmo_Red(tot) : '';
                 dpIn.value = ''; moIn.value = '';
             }
             if (t === moIn) {
                 const mo = parseFloat(t.value);
                 const tot = getV(totIn);
                 if (tot > 0) {
                     if (mo > 0) {
                         const newDp = (tot - (mo * 24));
                         dpIn.value = newDp !== '' ? Math.round(newDp * 100) / 100 : '';
                     } else { dpIn.value = ''; }
                 }
             }
             if (t === dpIn) {
                 const dp = parseFloat(t.value);
                 const tot = getV(totIn);
                 if (tot > 0) {
                     if (dp > 0) {
                         const newMo = calcTmo_Mo(tot, dp);
                         moIn.value = newMo;
                     } else { moIn.value = ''; }
                 }
             }
        });

        document.getElementById('btn-add-device').addEventListener('click', () => {
            const name = document.getElementById('new-name').value;
            if (!name) return alert("Required");
            const key = name.toLowerCase().replace(/[^a-z0-9]/g, '');
            const now = Date.now();
            
            log(`â¬†ï¸ ADDING: New Device ${name}...`);
            set(ref(db, 'devices/'+key), {
                name: name,
                att: { monthly: parseFloat(document.getElementById('new-att-mo').value)||0, total: parseFloat(document.getElementById('new-att-total').value)||0, last_updated: now },
                vzw: { monthly: parseFloat(document.getElementById('new-vzw-mo').value)||0, total: parseFloat(document.getElementById('new-vzw-total').value)||0, last_updated: now },
                tmo: { dp: parseFloat(document.getElementById('new-tmo-dp').value)||0, monthly: parseFloat(document.getElementById('new-tmo-mo').value)||0, total: parseFloat(document.getElementById('new-tmo-total').value)||0, last_updated: now },
                last_updated: now
            }).then(() => {
                log('âœ… ADDED: New device created.');
                addInputs.forEach(i => i.value = '');
            });
        });

        searchBar.addEventListener('input', renderTable);

    </script>
</body>
</html>